(this["webpackJsonptfjs-yolov5-example"]=this["webpackJsonptfjs-yolov5-example"]||[]).push([[0],{257:function(e,t,n){"use strict";n.r(t);var i=n(5),o=n.n(i),a=n(11),l=n(19),r=n(4),c=n(6),s=n(10),d=n(14),u=n(15),h=n(139),v=n.n(h),p=n(234),f=n.n(p),m=n(235),g=n.n(m),b=(n(265),n(59)),x=n(286),w="".concat("/tfjs-yolov5-example","/web_model/model.json"),y=["c","c1","castle","f","f1","g","g1","g2","m","m1","m2","m3","s","s1","s2","w","w1"],j={w:"rgba(13, 112, 239, 1)",m:"rgba(59, 64, 61, 1)",f:"rgba(70, 86, 50, 1)",c:"rgba(222, 191, 57, 1)",g:"rgba(130, 188, 68, 1)",s:"rgba(134, 126, 92, 1)",castle:"rgba(156, 156, 156, 1)"},O=function(e){Object(d.a)(n,e);var t=Object(u.a)(n);function n(){var e;Object(c.a)(this,n);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return(e=t.call.apply(t,[this].concat(o))).state={model:null,preview:"",predictions:[]},e.onDrop=function(t,n,i){e.setState({preview:t[0].preview||i[0]})},e.cropToCanvas=function(e,t,n){var i=e.naturalWidth,o=e.naturalHeight;n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle="#000000",n.fillRect(0,0,t.width,t.height);var a=Math.min(t.width/e.naturalWidth,t.height/e.naturalHeight),l=Math.round(i*a),r=Math.round(o*a);n.drawImage(e,0,0,i,o,(t.width-l)/2,(t.height-r)/2,l,r)},e.onImageChange=function(t){var n=document.getElementById("canvas"),i=n.getContext("2d");e.cropToCanvas(t.target,n,i);var o=x.image.resizeBilinear(x.browser.fromPixels(n),[416,416]).div(255).expandDims(0),a=performance.now();e.state.model.executeAsync(o).then((function(t){var c=performance.now(),s=document.createElement("div");s.innerHTML="Inference took: ".concat(c-a," ms"),document.body.appendChild(s);i.font="16px sans-serif",i.textBaseline="top";var d=t.map((function(e){return e.dataSync()})),u=Object(r.a)(d,4),h=u[0],v=u[1],p=u[2],f=Object(r.a)(u[3],1)[0];h=h.slice(0,4*f),v=v.slice(0,f),p=p.slice(0,f),console.log({boxes:h,scores:v,classes:p,validDetectionCount:f}),o.dispose(),x.dispose(t);var m=x.getBackend();x.setBackend("cpu");var g=x.tidy((function(){return x.image.nonMaxSuppression(x.tensor2d(h,[h.length/4,4]),v,49,.5,.5)}));x.setBackend(m);var b=g.dataSync(),w=Array.from(b).map((function(e){var t,n,i=h.slice(4*e,4*(e+1)),o=Object(r.a)(i,4),a=o[0],l=o[1],c=o[2],s=o[3],d=y[p[e]];return{type:null===d||void 0===d||null===(t=d.match(/^[a-z]+/))||void 0===t?void 0:t[0],crowns:Number((null===d||void 0===d||null===(n=d.match(/\d+$/))||void 0===n?void 0:n[0])||0),x1:a,y1:l,x2:c,y2:s,xm:(c+a)/2,ym:(s+l)/2,w:c-a,h:s-l}})),O={0:{}},M=w.findIndex((function(e){return"castle"===e.type}));if(-1!==M){var k=function e(t,n,i,o,a){var l,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{crowns:0,tiles:[]},c=B(i,o);return a[c]||(null===(l=t[o][i])||void 0===l?void 0:l.type)!==n||(r.crowns+=t[o][i].crowns,r.tiles.push(t[o][i]),r.type=n,r.score=r.crowns*r.tiles.length,a[c]=!0,i>0&&e(t,n,i-1,o,a,r),i<L-1&&e(t,n,i+1,o,a,r),o>0&&e(t,n,i,o-1,a,r),o<H-1&&e(t,n,i,o+1,a,r)),!!r.tiles.length&&r},S=w[M];O[0][0]=S,console.log("start",{castle:S,castleIndex:M,map:O});var D=[].concat(Object(l.a)(w.slice(0,M)),Object(l.a)(w.slice(M+1))),B=function(e,t){return"".concat(e,",").concat(t)},C=[[1,0],[0,1],[-1,0],[0,-1]],T={};!function e(t,n,i){var o=B(t,n);T[o]||(T[o]=!0,C.forEach((function(o){var a=Object(r.a)(o,2),l=a[0],c=a[1],s=i.x1+l*i.w,d=i.y1+c*i.h,u=i.x2+l*i.w,h=i.y2+c*i.h,v=D.findIndex((function(e){var t=e.xm,n=e.ym;return s<t&&u>t&&d<n&&h>n}));if(-1!==v){var p=D.splice(v,1),f=Object(r.a)(p,1)[0];O[n+c]=O[n+c]||{},O[n+c][t+l]=f,e(t+l,n+c,f)}})))}(0,0,S);var z=Object.keys(O).map(Number),I=Math.min.apply(Math,z),A=Object.values(O).map((function(e){return Object.keys(e).map(Number)})).flat(),N=Math.min.apply(Math,A),E=Object.entries(O).map((function(e){var t=Object(r.a)(e,2),n=t[0],i=t[1],o=Number(n)-I;return[o,Object.entries(i).reduce((function(e,t){var n=Object(r.a)(t,2),i=n[0],a=n[1],l=Number(i)-N;return a.x=l,a.y=o,e[l]=a,e}),[])]})).reduce((function(e,t){var n=Object(r.a)(t,2),i=n[0],o=n[1];return e[i]=o,e}),[]),H=E.length,L=Math.max.apply(Math,E.map((function(e){return e.length})));T={};var P=E.flat().map((function(e){return k(E,e.type,e.x,e.y,T)})).filter(Boolean);console.log({regions:P,normalizedMap:E}),P.forEach((function(e,t){i.strokeStyle=j[e.tiles[0].type],i.fillStyle=j[e.tiles[0].type],i.lineWidth=4;var o=new Path2D;o.moveTo(e.tiles[0].x1*n.width,e.tiles[0].y2*n.height);var a=[e.tiles[0].x,e.tiles[0].y,e.tiles[0].type],l=a[0],r=a[1],c=a[2],s=l,d=r,u=1,h=0;do{for(var v=0;v<4;v++){var p;h++;var f=null===(p=E[d])||void 0===p?void 0:p[s],m=f.x1,g=f.y1,b=f.x2,x=f.y2;if(0===u){var w,y;if(o.lineTo(m*n.width,x*n.height),e.tiles.includes(null===(w=E[d+1])||void 0===w?void 0:w[s-1])){s-=1,d+=1,u=3;continue}if(e.tiles.includes(null===(y=E[d])||void 0===y?void 0:y[s-1])){s-=1,u=0;continue}}if(1===u){var O,M;if(o.lineTo(m*n.width,g*n.height),e.tiles.includes(null===(O=E[d-1])||void 0===O?void 0:O[s-1])){s-=1,d-=1,u=0;continue}if(e.tiles.includes(null===(M=E[d-1])||void 0===M?void 0:M[s])){d-=1,u=1;continue}}if(2===u){var k,S;if(o.lineTo(b*n.width,g*n.height),e.tiles.includes(null===(k=E[d-1])||void 0===k?void 0:k[s+1])){s+=1,d-=1,u=1;continue}if(e.tiles.includes(null===(S=E[d])||void 0===S?void 0:S[s+1])){s+=1,u=2;continue}}if(3===u){var D,B;if(o.lineTo(b*n.width,x*n.height),e.tiles.includes(null===(D=E[d+1])||void 0===D?void 0:D[s+1])){s+=1,d+=1,u=2;continue}if(e.tiles.includes(null===(B=E[d+1])||void 0===B?void 0:B[s])){d+=1,u=3;continue}}u=(u+1)%4}}while((l!==s||r!==d||1!==u)&&h<1e3);o.closePath(),i.globalAlpha=.6,i.fill(o,"nonzero"),i.globalAlpha=1,i.shadowColor="black",i.shadowBlur=3,i.fillStyle="white",i.textAlign="right",i.textBaseline="middle";var C=e.tiles[0].h*n.height,T=Math.round(C/4.5);i.font="bold ".concat(T,"px Arial"),"castle"!==c&&0!==e.crowns&&(i.fillText("".concat(e.crowns," \ud83d\udc51"),n.width*e.tiles[0].x2-T/1.3,n.height*e.tiles[0].ym-1.3*T),i.fillText("\xd7 ".concat(e.tiles.length," \u23fa\ufe0f"),n.width*e.tiles[0].x2-T/1.3,n.height*e.tiles[0].ym),i.fillText("= ".concat(e.crowns*e.tiles.length," #\ufe0f\u20e3"),n.width*e.tiles[0].x2-T/1.3,n.height*e.tiles[0].ym+1.3*T)),i.shadowBlur=0})),e.setState({regions:P,map:E,score:P.reduce((function(e,t){return e+t.score}),0)})}console.log({castleIndex:M,map:O,sortedMatches:w})}))},e}return Object(s.a)(n,[{key:"componentDidMount",value:function(){var e=Object(a.a)(o.a.mark((function e(){var t=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:x.loadGraphModel(w).then((function(e){console.log({model:e}),t.setState({model:e})}));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e,t,n,i,o,a,l,r;return Object(b.jsx)("div",{className:"Dropzone-page",children:this.state.model?Object(b.jsxs)(b.Fragment,{children:[Object(b.jsxs)("div",{children:[(this.state.model.artifacts.weightData.byteLength/1024/1024).toFixed(3)," ","Mb"]}),Object(b.jsxs)(g.a,{className:"Dropzone",accept:"image/jpeg, image/png, .jpg, .jpeg, .png",multiple:!1,onDrop:this.onDrop,children:[this.state.preview?Object(b.jsx)("img",{alt:"upload preview",onLoad:this.onImageChange,className:"Dropzone-img",src:this.state.preview}):"Choose or drop a file.",Object(b.jsx)("canvas",{id:"canvas",width:"640",height:"640"})]}),Object(b.jsxs)("div",{style:{position:"relative",textAlign:"center"},children:[null===(e=this.state)||void 0===e||null===(t=e.map)||void 0===t?void 0:t.flat().map((function(e){return Object(b.jsx)("div",{style:{width:20,height:20,backgroundColor:j[e.type],position:"absolute",left:20*e.x,top:20*e.y,fontSize:16,lineHeight:"20px",textShadow:"0 0 2px rgba(0, 0, 0, 0.6)"},children:new Array(e.crowns?1:0).fill("\ud83d\udc51")})})),Object(b.jsx)("div",{style:{fontSize:20*((null===(n=this.state)||void 0===n||null===(i=n.map)||void 0===i?void 0:i.length)-1),lineHeight:"".concat(20*(null===(o=this.state)||void 0===o||null===(a=o.map)||void 0===a?void 0:a.length),"px"),width:20*(null===(l=this.state)||void 0===l||null===(r=l.map)||void 0===r?void 0:r.length),position:"relative",color:"#fff",textShadow:"0 0 4px rgba(0, 0, 0, 0.6)"},children:this.state.score})]})]}):Object(b.jsx)("div",{className:"Dropzone",children:"Loading model..."})})}}]),n}(v.a.Component),M=document.getElementById("root");f.a.render(Object(b.jsx)(O,{}),M)},265:function(e,t,n){},271:function(e,t){},272:function(e,t){},280:function(e,t){},283:function(e,t){},284:function(e,t){},285:function(e,t){}},[[257,1,2]]]);
//# sourceMappingURL=main.b6d4449c.chunk.js.map