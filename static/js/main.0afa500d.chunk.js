(this["webpackJsonptfjs-yolov5-example"]=this["webpackJsonptfjs-yolov5-example"]||[]).push([[0],{257:function(e,t,n){"use strict";n.r(t);var i=n(5),a=n.n(i),o=n(11),c=n(19),r=n(4),l=n(6),s=n(10),u=n(14),d=n(15),h=n(139),m=n.n(h),v=n(234),f=n.n(v),p=n(235),g=n.n(p),x=(n(265),n(76)),y=n(286),b="".concat("/tfjs-yolov5-example","/web_model/model.json"),w=["c","c1","castle","f","f1","g","g1","g2","m","m1","m2","m3","s","s1","s2","w","w1"],j=function(e){Object(u.a)(n,e);var t=Object(d.a)(n);function n(){var e;Object(l.a)(this,n);for(var i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return(e=t.call.apply(t,[this].concat(a))).state={model:null,preview:"",predictions:[]},e.onDrop=function(t,n,i){e.setState({preview:t[0].preview||i[0]})},e.cropToCanvas=function(e,t,n){var i=e.naturalWidth,a=e.naturalHeight;n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle="#000000",n.fillRect(0,0,t.width,t.height);var o=Math.min(t.width/e.naturalWidth,t.height/e.naturalHeight),c=Math.round(i*o),r=Math.round(a*o);n.drawImage(e,0,0,i,a,(t.width-c)/2,(t.height-r)/2,c,r)},e.onImageChange=function(t){var n=document.getElementById("canvas"),i=n.getContext("2d");e.cropToCanvas(t.target,n,i);var a=y.image.resizeBilinear(y.browser.fromPixels(n),[416,416]).div(255).expandDims(0),o=performance.now();e.state.model.executeAsync(a).then((function(e){var t=performance.now(),l=document.createElement("div");l.innerHTML="Inference took: ".concat(t-o," ms"),document.body.appendChild(l);i.font="16px sans-serif",i.textBaseline="top";var s=e.map((function(e){return e.dataSync()})),u=Object(r.a)(s,4),d=u[0],h=u[1],m=u[2],v=Object(r.a)(u[3],1)[0];d=d.slice(0,4*v),h=h.slice(0,v),m=m.slice(0,v),console.log({boxes:d,scores:h,classes:m,validDetectionCount:v}),a.dispose(),y.dispose(e);var f=y.tidy((function(){return y.image.nonMaxSuppression(y.tensor2d(d,[d.length/4,4]),h,49,.5,.5)})).dataSync(),p=Array.from(f).map((function(e){var t,n,i=d.slice(4*e,4*(e+1)),a=Object(r.a)(i,4),o=a[0],c=a[1],l=a[2],s=a[3],u=w[m[e]];return{type:null===(t=u.match(/^[a-z]+/))||void 0===t?void 0:t[0],crowns:Number((null===(n=u.match(/\d+$/))||void 0===n?void 0:n[0])||0),x1:o,y1:c,x2:l,y2:s,xm:(l+o)/2,ym:(s+c)/2,w:l-o,h:s-c}})),g=[{k:"x1",MathFunction:Math.min},{k:"x2",MathFunction:Math.max},{k:"y1",MathFunction:Math.min},{k:"y2",MathFunction:Math.max}].map((function(e){var t=e.k,n=e.MathFunction;return n.apply(n,p.map((function(e){return e[t]})))})),x=Object(r.a)(g,4),b=x[0],j=x[1],M=x[2],O=x[3];console.log({xMin:b,xMax:j,yMin:M,yMax:O});var k=p.map((function(e){return e.xm})).reduce((function(e,t){return Math.min(e,t)})),D=p.map((function(e){return e.xm})).reduce((function(e,t){return Math.max(e,t)}));console.log({sortedMatches:p,indices:f,xmmin:k,xmmax:D});var T={0:{}},C=p.findIndex((function(e){return"castle"===e.type}));if(-1!==C){var I=function e(t,n,i,a,o){var c,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{crowns:0,tiles:[]},l=z(i,a);return o[l]||(null===(c=t[a][i])||void 0===c?void 0:c.type)!==n||(r.crowns+=t[a][i].crowns,r.tiles.push(t[a][i]),r.type=n,o[l]=!0,i>0&&e(t,n,i-1,a,o,r),i<J-1&&e(t,n,i+1,a,o,r),a>0&&e(t,n,i,a-1,o,r),a<W-1&&e(t,n,i,a+1,o,r)),!!r.tiles.length&&r},N=p[C];T[0][0]=N,console.log("start",{castle:N,castleIndex:C,map:T});var S=[].concat(Object(c.a)(p.slice(0,C)),Object(c.a)(p.slice(C+1))),z=function(e,t){return"".concat(e,",").concat(t)},B=[[1,0],[0,1],[-1,0],[0,-1]],F={};!function e(t,n,i){var a=z(t,n);F[a]||(F[a]=!0,B.forEach((function(a){var o=Object(r.a)(a,2),c=o[0],l=o[1],s=i.x1+c*i.w,u=i.y1+l*i.h,d=i.x2+c*i.w,h=i.y2+l*i.h,m=S.findIndex((function(e){var t=e.xm,n=e.ym;return s<t&&d>t&&u<n&&h>n}));if(-1!==m){var v=S.splice(m,1),f=Object(r.a)(v,1)[0];T[n+l]=T[n+l]||{},T[n+l][t+c]=f,e(t+c,n+l,f)}})))}(0,0,N);var A=Object.keys(T).map(Number),E=Math.min.apply(Math,A),L=Object.values(T).map((function(e){return Object.keys(e).map(Number)})).flat(),H=Math.min.apply(Math,L),P=Object.entries(T).map((function(e){var t=Object(r.a)(e,2),n=t[0],i=t[1],a=Number(n)-E;return[a,Object.entries(i).reduce((function(e,t){var n=Object(r.a)(t,2),i=n[0],o=n[1],c=Number(i)-H;return o.x=c,o.y=a,e[c]=o,e}),[])]})).reduce((function(e,t){var n=Object(r.a)(t,2),i=n[0],a=n[1];return e[i]=a,e}),[]),W=P.length,J=Math.max.apply(Math,P.map((function(e){return e.length})));F={};var R=P.flat().map((function(e){return I(P,e.type,e.x,e.y,F)})).filter(Boolean);console.log({regions:R,normalizedMap:P}),R.forEach((function(e,t){var a={w:"rgba(13, 112, 239, 0.6)",m:"rgba(59, 64, 61, 0.6)",f:"rgba(70, 86, 50, 0.6)",c:"rgba(222, 191, 57, 0.6)",g:"rgba(130, 188, 68, 0.6)",s:"rgba(134, 126, 92, 0.6)",castle:"rgba(128, 128, 128, 0.6)"};i.strokeStyle=a[e.tiles[0].type],i.fillStyle=a[e.tiles[0].type],i.lineWidth=4;var o=new Path2D;o.moveTo(e.tiles[0].x1*n.width,e.tiles[0].y2*n.height);var c=[e.tiles[0].x,e.tiles[0].y,e.tiles[0].type],r=c[0],l=c[1],s=c[2],u=r,d=l,h=1,m=0;do{for(var v=0;v<4;v++){var f;m++;var p=null===(f=P[d])||void 0===f?void 0:f[u],g=p.x1,x=p.y1,y=p.x2,b=p.y2;if(0===h){var w,j;if(o.lineTo(g*n.width,b*n.height),e.tiles.includes(null===(w=P[d+1])||void 0===w?void 0:w[u-1])){u-=1,d+=1,h=3;continue}if(e.tiles.includes(null===(j=P[d])||void 0===j?void 0:j[u-1])){u-=1,h=0;continue}}if(1===h){var M,O;if(o.lineTo(g*n.width,x*n.height),e.tiles.includes(null===(M=P[d-1])||void 0===M?void 0:M[u-1])){u-=1,d-=1,h=0;continue}if(e.tiles.includes(null===(O=P[d-1])||void 0===O?void 0:O[u])){d-=1,h=1;continue}}if(2===h){var k,D;if(o.lineTo(y*n.width,x*n.height),e.tiles.includes(null===(k=P[d-1])||void 0===k?void 0:k[u+1])){u+=1,d-=1,h=1;continue}if(e.tiles.includes(null===(D=P[d])||void 0===D?void 0:D[u+1])){u+=1,h=2;continue}}if(3===h){var T,C;if(o.lineTo(y*n.width,b*n.height),e.tiles.includes(null===(T=P[d+1])||void 0===T?void 0:T[u+1])){u+=1,d+=1,h=2;continue}if(e.tiles.includes(null===(C=P[d+1])||void 0===C?void 0:C[u])){d+=1,h=3;continue}}h=(h+1)%4}}while((r!==u||l!==d||1!==h)&&m<1e3);o.closePath(),i.fill(o,"nonzero"),i.shadowColor="black",i.shadowBlur=3,i.fillStyle="white",i.textAlign="right",i.textBaseline="middle";var I=e.tiles[0].h*n.height,N=Math.round(I/4.5);i.font="".concat(N,"px Arial"),"castle"!==s&&0!==e.crowns&&(i.fillText("".concat(e.crowns," \ud83d\udc51"),n.width*e.tiles[0].x2-N/1.3,n.height*e.tiles[0].ym-1.3*N),i.fillText("\xd7 ".concat(e.tiles.length," \u23fa\ufe0f"),n.width*e.tiles[0].x2-N/1.3,n.height*e.tiles[0].ym),i.fillText("= ".concat(e.crowns*e.tiles.length," #\ufe0f\u20e3"),n.width*e.tiles[0].x2-N/1.3,n.height*e.tiles[0].ym+1.3*N)),i.shadowBlur=0}))}console.log({castleIndex:C,map:T,sortedMatches:p})}))},e}return Object(s.a)(n,[{key:"componentDidMount",value:function(){var e=Object(o.a)(a.a.mark((function e(){var t=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:y.loadGraphModel(b).then((function(e){console.log({model:e}),t.setState({model:e})}));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){return Object(x.jsx)("div",{className:"Dropzone-page",children:this.state.model?Object(x.jsxs)(x.Fragment,{children:[Object(x.jsxs)("div",{children:[(this.state.model.artifacts.weightData.byteLength/1024/1024).toFixed(3)," ","Mb"]}),Object(x.jsxs)(g.a,{className:"Dropzone",accept:"image/jpeg, image/png, .jpg, .jpeg, .png",multiple:!1,onDrop:this.onDrop,children:[this.state.preview?Object(x.jsx)("img",{alt:"upload preview",onLoad:this.onImageChange,className:"Dropzone-img",src:this.state.preview}):"Choose or drop a file.",Object(x.jsx)("canvas",{id:"canvas",width:"640",height:"640"})]})]}):Object(x.jsx)("div",{className:"Dropzone",children:"Loading model..."})})}}]),n}(m.a.Component),M=document.getElementById("root");f.a.render(Object(x.jsx)(j,{}),M)},265:function(e,t,n){},271:function(e,t){},272:function(e,t){},280:function(e,t){},283:function(e,t){},284:function(e,t){},285:function(e,t){}},[[257,1,2]]]);
//# sourceMappingURL=main.0afa500d.chunk.js.map